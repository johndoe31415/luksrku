#!/bin/sh
#
# Initcpio install script for remote LUKS unlocking
#
# By Georg Pfuetzenreuter <mail@georg-pfuetzenreuter.net>

if [ ! -f /etc/luksrku-client.bin ]; then
        exit 0
fi
build() {
    local mod

    add_module "dm-crypt"
    add_module "dm-integrity"
    if [[ $CRYPTO_MODULES ]]; then
        for mod in $CRYPTO_MODULES; do
            add_module "$mod"
        done
    else
        add_all_modules "/crypto/"
    fi

    add_binary "cryptsetup"
    add_binary "dmsetup"
    add_file "/usr/lib/udev/rules.d/10-dm.rules"
    add_file "/usr/lib/udev/rules.d/13-dm-disk.rules"
    add_file "/usr/lib/udev/rules.d/95-dm-notify.rules"
    add_file "/usr/lib/initcpio/udev/11-dm-initramfs.rules" "/usr/lib/udev/rules.d/11-dm-initramfs.rules"

    add_binary "/usr/lib/libgcc_s.so.1"

    add_file "/etc/luksrku-client.bin" "/etc/luksrku-client.bin"
    add_binary "/usr/local/sbin/luksrku" "/usr/bin/luksrku"
    add_runscript
}
